name: éƒ¨ç½²åˆ°è…¾è®¯äº‘

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: å®‰è£…ä¾èµ–
      run: npm ci
    
    - name: æ„å»ºé¡¹ç›®
      run: npm run build
    
    - name: ç™»å½•è…¾è®¯äº‘å®¹å™¨é•œåƒæœåŠ¡
      run: |
        docker login --username=${{ secrets.TENCENT_CLOUD_USERNAME }} \
          --password=${{ secrets.TENCENT_CLOUD_PASSWORD }} \
          ccr.ccs.tencentyun.com
    
    - name: æ„å»º Docker é•œåƒ
      run: |
        docker build -t monster-tech-portal:${{ github.sha }} .
        docker tag monster-tech-portal:${{ github.sha }} \
          ccr.ccs.tencentyun.com/${{ secrets.TENCENT_CLOUD_NAMESPACE }}/monster-tech-portal:latest
        docker tag monster-tech-portal:${{ github.sha }} \
          ccr.ccs.tencentyun.com/${{ secrets.TENCENT_CLOUD_NAMESPACE }}/monster-tech-portal:${{ github.sha }}
    
    - name: æ¨é€é•œåƒåˆ°è…¾è®¯äº‘
      run: |
        docker push ccr.ccs.tencentyun.com/${{ secrets.TENCENT_CLOUD_NAMESPACE }}/monster-tech-portal:latest
        docker push ccr.ccs.tencentyun.com/${{ secrets.TENCENT_CLOUD_NAMESPACE }}/monster-tech-portal:${{ github.sha }}
    
    - name: éƒ¨ç½²é€šçŸ¥
      run: |
        echo "âœ… é•œåƒå·²æˆåŠŸæ¨é€åˆ°è…¾è®¯äº‘å®¹å™¨é•œåƒæœåŠ¡"
        echo "ğŸ“¦ é•œåƒåœ°å€: ccr.ccs.tencentyun.com/${{ secrets.TENCENT_CLOUD_NAMESPACE }}/monster-tech-portal:latest"
        echo "ğŸš€ è¯·ç™»å½•è…¾è®¯äº‘æ§åˆ¶å°æ›´æ–°å®¹å™¨å®ä¾‹"

    # å¯é€‰ï¼šè‡ªåŠ¨æ›´æ–° TKE éƒ¨ç½²ï¼ˆéœ€è¦é…ç½® kubeconfigï¼‰
    # - name: æ›´æ–° TKE éƒ¨ç½²
    #   run: |
    #     kubectl set image deployment/monster-tech-portal \
    #       monster-tech-portal=ccr.ccs.tencentyun.com/${{ secrets.TENCENT_CLOUD_NAMESPACE }}/monster-tech-portal:${{ github.sha }}

